---
description: Prevent logging of sensitive information like API keys, passwords, and tokens
globs:
  - "manchego/**/*.py"
alwaysApply: false
---

# Secret Sanitization

Never log sensitive information in plaintext. Always sanitize data before logging to prevent credential leakage.

## Sensitive Information Types

### Never Log

- **API keys**: Full Google API keys, OpenAI keys, etc.
- **Passwords**: Database passwords, user passwords
- **Tokens**: OAuth tokens, access tokens, refresh tokens
- **Private keys**: SSH keys, SSL certificates
- **Secrets**: Any value marked as secret in config

### Truncate

- **IDs**: Show first 8 characters only
  - Sheet IDs: `1ttXvQx...` instead of full ID
  - Receipt IDs: `550e8400...` instead of full UUID
  - User IDs: `12345678...` instead of full ID

### Redact

- **Email addresses**: Show domain only: `***@gmail.com`
- **Phone numbers**: Show last 4 digits: `***-***-1234`
- **Credit card numbers**: Show last 4 digits: `****-****-****-1234`

## Sanitization Helper

Use the sanitization helper function when logging data that might contain sensitive information:

```python
from manchego.utils.logging_helpers import sanitize_for_logging

# Example 1: Sanitizing API response data
data = {
    "sheet_id": "1ttXvQxLm9z8YnKqJpWvBxCzDyEfGhIjK",
    "api_key": "AIzaSyD1234567890abcdefghijklmnopqrstuv",
    "receipt_id": "550e8400-e29b-41d4-a716-446655440000",
    "user_email": "user@example.com"
}

sanitized = sanitize_for_logging(data)
# Result: {
#   "sheet_id": "1ttXvQx...",
#   "api_key": "***REDACTED***",
#   "receipt_id": "550e8400...",
#   "user_email": "***@example.com"
# }

logger.info("Operation data", extra={
    "operation_id": operation_id,
    "data": sanitized
})
```

## Real-World Usage Examples

### Example 1: Google Sheets API Response

```python
def append_to_sheet(data, sheet_id, api_key):
    response = sheets_api.append(sheet_id, data, api_key)
    
    # Sanitize before logging
    log_data = sanitize_for_logging({
        "sheet_id": sheet_id,
        "api_key": api_key,
        "rows_added": len(data),
        "status": response.status
    })
    
    logger.info("Data appended to sheet", extra={
        "operation_id": operation_id,
        "data": log_data
    })
```

### Example 2: User Configuration

```python
def load_config():
    config = {
        "openai_api_key": os.getenv("OPENAI_API_KEY"),
        "google_api_key": os.getenv("GOOGLE_API_KEY"),
        "spreadsheet_id": os.getenv("SPREADSHEET_ID"),
        "user_email": os.getenv("USER_EMAIL")
    }
    
    # Sanitize before logging
    safe_config = sanitize_for_logging(config)
    
    logger.info("Configuration loaded", extra={
        "operation_id": operation_id,
        "data": safe_config
    })
    # Logs: {
    #   "openai_api_key": "***REDACTED***",
    #   "google_api_key": "***REDACTED***",
    #   "spreadsheet_id": "1ttXvQx...",
    #   "user_email": "***@gmail.com"
    # }
```

### Example 3: Database Connection String

```python
def connect_to_database(conn_string):
    # Sanitize connection string before logging
    safe_string = conn_string.split("@")[1] if "@" in conn_string else conn_string
    
    logger.info("Connecting to database", extra={
        "operation_id": operation_id,
        "data": {
            "connection": f"***:***@{safe_string}"
        }
    })
```

## Manual Sanitization

When not using the helper, sanitize manually:

```python
# Truncate long IDs
logger.info("Processing sheet", extra={
    "data": {
        "sheet_id": f"{sheet_id[:8]}...",  # First 8 chars only
        "rows": rows
    }
})

# Redact API keys
logger.debug("API configuration", extra={
    "data": {
        "api_key": "***REDACTED***",
        "endpoint": api_endpoint
    }
})

# Show email domain only
logger.info("User action", extra={
    "data": {
        "user": f"***@{email.split('@')[1]}"
    }
})
```

## Configuration Logging

When logging configuration, exclude secrets:

❌ **Avoid:**
```python
import os
logger.info("Configuration loaded", extra={
    "data": {
        "api_key": os.getenv("GOOGLE_API_KEY"),
        "sheet_id": os.getenv("SPREADSHEET_ID")
    }
})
```

✅ **Prefer:**
```python
import os
logger.info("Configuration loaded", extra={
    "data": {
        "api_key": "***CONFIGURED***" if os.getenv("GOOGLE_API_KEY") else "***MISSING***",
        "sheet_id": f"{os.getenv('SPREADSHEET_ID', '')[:8]}..." if os.getenv("SPREADSHEET_ID") else "***MISSING***"
    }
})
```

## Error Logging with Secrets

Be careful when logging errors that might contain secrets:

```python
try:
    response = requests.post(url, headers={"Authorization": f"Bearer {token}"})
    response.raise_for_status()
except requests.HTTPError as e:
    # Don't log the full response which might contain sensitive headers
    logger.error("API request failed", extra={
        "operation_id": operation_id,
        "data": {
            "url": url,
            "status_code": e.response.status_code,
            "error": str(e)  # Safe - doesn't include headers
        }
    })
```

## Environment Variables

When logging environment info, redact sensitive vars:

```python
import os

SENSITIVE_ENV_VARS = {
    "GOOGLE_API_KEY",
    "OPENAI_API_KEY",
    "DATABASE_PASSWORD",
    "SECRET_KEY"
}

env_info = {}
for key, value in os.environ.items():
    if key in SENSITIVE_ENV_VARS:
        env_info[key] = "***REDACTED***"
    elif "KEY" in key or "SECRET" in key or "PASSWORD" in key:
        env_info[key] = "***REDACTED***"
    else:
        env_info[key] = value

logger.debug("Environment variables", extra={"data": env_info})
```

## Database Connection Strings

Never log full connection strings:

❌ **Avoid:**
```python
conn_string = "postgresql://user:password@localhost:5432/database"
logger.info(f"Connecting to {conn_string}")
```

✅ **Prefer:**
```python
conn_string = "postgresql://user:password@localhost:5432/database"
safe_string = "postgresql://***:***@localhost:5432/database"
logger.info("Connecting to database", extra={
    "data": {"connection": safe_string}
})
```

## File Paths with Usernames

Sanitize file paths that might contain usernames:

```python
import os
from pathlib import Path

def sanitize_path(path: Path) -> str:
    """Replace home directory with ~ for privacy."""
    try:
        return str(path.relative_to(Path.home()).as_posix())
    except ValueError:
        return str(path)

logger.info("Processing file", extra={
    "data": {
        "file": file.name,
        "path": sanitize_path(file)  # Shows relative path
    }
})
```

## Sanitization Patterns

The `sanitize_for_logging()` helper checks for these patterns:

- Keys ending in `_key`, `_token`, `_secret`, `_password`
- Keys named `api_key`, `apikey`, `password`, `secret`, `token`
- Keys ending in `_id` (truncates to 8 chars)
- Keys named `email` (shows domain only)

Customize patterns in `manchego/utils/logging_helpers.py` as needed.

## Audit for Leaks

Regularly search logs for potential leaks:

```bash
# Check for common patterns
grep -r "AIzaSy" data/logs/  # Google API keys
grep -r "sk-" data/logs/      # OpenAI keys
grep -r "password" data/logs/ # Passwords in logs
```

If found, rotate the exposed credentials immediately and update sanitization rules.
